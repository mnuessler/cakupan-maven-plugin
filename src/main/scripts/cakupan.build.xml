<?xml version='1.0' encoding='UTF-8'?>
<!-- 
   Copyright 2011 Matthias Nuessler

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
-->
<project>
	<taskdef resource="cakupantasks.properties" />

	<property name="level" value="info" />

	<target name="instrument">
		<echo message="instrument.outputDirectory = ${instrument.outputDirectory}" level="${level}" />
		<echo message="xsl.sourceDirectory = ${xsl.sourceDirectory}" level="${level}" />
		<echo message="xsl.includes = ${xsl.includes}" level="${level}" />

		<cakupan-instrument destdir="${instrument.outputDirectory}">
			<fileset dir="${xsl.sourceDirectory}" includes="${xsl.includes}" />
		</cakupan-instrument>
	</target>

	<target name="test" description="Runs the XSL transformation tests">
		<echo message="instrument.outputDirectory = ${instrument.outputDirectory}" level="${level}" />
		<echo message="testResultDirectory = ${testResultDirectory}" level="${level}" />
		<echo message="testSourceDirectory = ${testSourceDirectory}" level="${level}" />
		<echo message="test.includes = ${test.includes}" level="${level}" />

		<property name="compile_classpath" refid="maven.compile.classpath" />
		<property name="runtime_classpath" refid="maven.runtime.classpath" />
		<property name="test_classpath" refid="maven.test.classpath" />
		<property name="plugin_classpath" refid="maven.plugin.classpath" />

		<echo message="compile classpath: ${compile_classpath}" />
		<echo message="runtime classpath: ${runtime_classpath}" />
		<echo message="test classpath:    ${test_classpath}" />
		<echo message="plugin classpath:  ${plugin_classpath}" />
		<echo message="cakupan.maven.test.classpath: ${cakupan.maven.test.classpath}" />
		
		<property name="myclasspath" value="${test_classpath}:${cakupan.maven.test.classpath}" />
		<echo message="myclasspath: ${myclasspath}" />
		
		<mkdir dir="${testResultDirectory}" />
		<junit printsummary="yes" haltonfailure="no" fork="true">
			<!--sysproperty key="javax.xml.transform.TransformerFactory" value="com.cakupan.xslt.transform.XalanTransformerInstrumentFactoryImpl" 
				/ -->
			<sysproperty key="javax.xml.transform.TransformerFactory" value="com.cakupan.xslt.transform.SaxonCakupanTransformerInstrumentFactoryImpl" />
			<sysproperty key="cakupan.dir" value="${instrument.outputDirectory}" />
			<classpath>
				<!-- 
				    Dependency artifacts are not in the classpath for some reason.
				    For a possible workaround see http://blog.akquinet.de/2010/05/11/using-the-maven-ant-tasks-from-within-a-ant-based-maven-plugin/
				    Or use: mvn dependency:build-classpath -DoutputFilterFile=<file> -DincludeScope=test
				-->
				<!--path refid="maven.test.classpath" /-->
				<!--path refid="maven.plugin.classpath" /-->
				<!--pathelement path="/Users/mnuessler/Documents/projects/is24/esb/apps/erpadaptor/target/test-classes:/Users/mnuessler/Documents/projects/is24/esb/apps/erpadaptor/target/classes:${cakupan.maven.test.classpath}" /-->
				<pathelement path="${myclasspath}" />
			</classpath>
			<formatter type="xml" />
			<formatter type="plain" />
			<batchtest fork="yes" todir="${testResultDirectory}">
				<fileset dir="${testSourceDirectory}" includes="${test.includes}" />
			</batchtest>
		</junit>
	</target>

	<target name="report">
		<cakupan-report destdir="${report.outputDirectory}" />
	</target>

</project>
